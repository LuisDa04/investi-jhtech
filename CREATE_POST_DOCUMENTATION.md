# CreatePostScreen - Documentaci√≥n Completa

## üìã Resumen

Refactorizaci√≥n completa del `CreatePostScreen` para ser **pixel-perfect**, **backend-driven** y **production-ready** con React Native, TypeScript, y Supabase.

---

## üéØ Archivos Entregados

### 1. **Componentes Nuevos**

#### `src/components/pickers/AudiencePicker.tsx`
- **Descripci√≥n**: Selector paginado de audiencia (Perfil/Comunidades) con b√∫squeda y debounce (300ms)
- **Props**:
  - `visible: boolean` - Controla visibilidad del modal
  - `onClose: () => void` - Callback al cerrar
  - `onSelect: (audience: AudienceOption) => void` - Callback al seleccionar
  - `currentUserId: string` - ID del usuario actual
  - `selectedAudience?: AudienceOption` - Audiencia seleccionada
  - `fetchCommunities: (userId, query, page) => Promise<{items, hasMore}>` - Funci√≥n para cargar comunidades
- **Caracter√≠sticas**:
  - B√∫squeda con debounce de 300ms
  - Paginaci√≥n infinita con "pull to append"
  - Opci√≥n "Mi Perfil" siempre primera
  - Placeholders con iniciales si no hay imagen
  - Accesibilidad completa (labels, roles, hitSlop)

#### `src/components/media/MediaPreview.tsx`
- **Descripci√≥n**: Carrusel horizontal de media con progreso de subida y retry
- **Props**:
  - `items: MediaItem[]` - Array de archivos multimedia
  - `onRemove: (id: string) => void` - Callback para eliminar
  - `onRetry?: (id: string) => void` - Callback para reintentar subida
- **Caracter√≠sticas**:
  - Soporte para image, video, document
  - Barra de progreso de subida
  - Bot√≥n de retry en caso de error
  - Muestra tama√±o de archivo
  - Scroll horizontal fluido

#### `src/components/poll/PollEditor.tsx`
- **Descripci√≥n**: Editor de encuestas con 2-5 opciones y duraci√≥n configurable
- **Props**:
  - `visible: boolean` - Controla visibilidad
  - `onClose: () => void` - Callback al cerrar
  - `onSave: (poll: PollData) => void` - Callback al guardar
  - `initialData?: PollData` - Datos iniciales (para edici√≥n)
- **Caracter√≠sticas**:
  - 2-5 opciones (m√≠nimo 2, m√°ximo 5)
  - M√°ximo 80 caracteres por opci√≥n
  - Duraci√≥n: 1, 3 o 7 d√≠as
  - Validaci√≥n en tiempo real
  - Contador de caracteres por opci√≥n

---

### 2. **API Client - Nuevas Funciones** (`src/rest/api.ts`)

#### `uploadMedia(fileUri, kind, userId)`
```typescript
uploadMedia(
  fileUri: string,
  kind: 'image' | 'video',
  userId: string
): Promise<{ url: string; mime: string; bytes: number }>
```
- **Descripci√≥n**: Sube archivos a Supabase Storage bucket `media` (solo im√°genes y videos)
- **Carpetas**: `{kind}/{userId}/{fecha}/{timestamp}_{random}.{ext}`
- **Response**:
  ```json
  {
    "url": "https://.../storage/v1/object/public/media/images/user-id/2025-10-01/...",
    "mime": "image/jpeg",
    "bytes": 245678
  }
  ```

#### `listCommunitiesPaged(userId, q, page, pageSize)`
```typescript
listCommunitiesPaged(
  userId: string,
  q: string,
  page: number,
  pageSize?: number
): Promise<{ items: Array<{id, name, image_url, member_count}>, hasMore: boolean }>
```
- **Descripci√≥n**: Lista comunidades del usuario con paginaci√≥n y b√∫squeda
- **Par√°metros**:
  - `userId`: ID del usuario
  - `q`: Query de b√∫squeda (filtro client-side)
  - `page`: N√∫mero de p√°gina (1-indexed)
  - `pageSize`: Tama√±o de p√°gina (default: 20)
- **Response**:
  ```json
  {
    "items": [
      {
        "id": "uuid",
        "name": "Inversores Nicaragua",
        "image_url": "https://...",
        "member_count": 1250
      }
    ],
    "hasMore": true
  }
  ```

#### `createPostFull(payload)`
```typescript
createPostFull(payload: {
  user_id: string
  content: string
  audience_type: 'profile' | 'community'
  audience_id?: string
  media?: Array<{ url, type, mime, size }>
  poll?: { options: string[], duration_days: number }
  celebration?: { type: string }
  partnership?: { business_type, investment_amount, location }
}): Promise<{ id: string }>
```
- **Descripci√≥n**: Crea post con todos sus hijos (media, poll, celebration, partnership)
- **L√≥gica**:
  1. Intenta usar RPC `create_post_with_children` (si existe)
  2. Fallback: crea post manualmente + inserts en tablas relacionadas
- **Response**:
  ```json
  {
    "id": "post-uuid"
  }
  ```

#### Draft Management
```typescript
saveDraft(draft: {...}): Promise<void>
loadDraft(): Promise<any | null>
clearDraft(): Promise<void>
```
- **Descripci√≥n**: Gesti√≥n de borradores con AsyncStorage
- **Key**: `create_post_draft`
- **Autosave**: Cada 2 segundos si hay cambios

---

### 3. **SQL Migrations** (`supabase/sql/create_post.sql`)

#### Tablas Creadas

**`post_media`**
```sql
id UUID PRIMARY KEY
post_id UUID REFERENCES posts(id) ON DELETE CASCADE
media_url TEXT NOT NULL
media_type TEXT CHECK (media_type IN ('image', 'video', 'document'))
mime_type TEXT
file_size BIGINT
display_order INTEGER DEFAULT 0
created_at TIMESTAMPTZ DEFAULT NOW()
```

**`polls`**
```sql
id UUID PRIMARY KEY
post_id UUID REFERENCES posts(id) ON DELETE CASCADE
duration_hours INTEGER NOT NULL DEFAULT 24
ends_at TIMESTAMPTZ NOT NULL
total_votes INTEGER DEFAULT 0
created_at TIMESTAMPTZ
updated_at TIMESTAMPTZ
```

**`poll_options`**
```sql
id UUID PRIMARY KEY
poll_id UUID REFERENCES polls(id) ON DELETE CASCADE
option_text TEXT CHECK (char_length(option_text) <= 80)
option_order INTEGER NOT NULL
vote_count INTEGER DEFAULT 0
created_at TIMESTAMPTZ
```

**`poll_votes`**
```sql
id UUID PRIMARY KEY
poll_id UUID REFERENCES polls(id) ON DELETE CASCADE
option_id UUID REFERENCES poll_options(id) ON DELETE CASCADE
user_id UUID REFERENCES users(id) ON DELETE CASCADE
created_at TIMESTAMPTZ
UNIQUE(poll_id, user_id)
```

**`post_celebrations`**
```sql
id UUID PRIMARY KEY
post_id UUID REFERENCES posts(id) ON DELETE CASCADE
celebration_type TEXT CHECK (celebration_type IN ('milestone', 'achievement', 'success', 'investment_win', 'other'))
created_at TIMESTAMPTZ
```

**`post_partnerships`**
```sql
id UUID PRIMARY KEY
post_id UUID REFERENCES posts(id) ON DELETE CASCADE
business_type TEXT NOT NULL
investment_amount TEXT
location TEXT
partnership_type TEXT DEFAULT 'equity'
requirements TEXT[]
contact_preferences TEXT[]
created_at TIMESTAMPTZ
```

#### RPC Functions

**`create_post_with_children(payload JSON)`**
- Crea post + media + poll + poll_options + celebration + partnership en una transacci√≥n
- Retorna `{ "id": "post-uuid" }`

**`get_user_communities_paged(p_user_id, p_query, p_page, p_page_size)`**
- Pagina comunidades del usuario con b√∫squeda
- Retorna `{ "items": [...], "hasMore": boolean }`

#### RLS Policies
- Todas las tablas tienen RLS habilitado
- Lectura p√∫blica (`SELECT`)
- Escritura solo del owner (`INSERT`, `DELETE`)
- `poll_votes`: escritura solo del usuario autenticado

#### Triggers
- `update_polls_updated_at`: Actualiza `updated_at` en polls
- `update_poll_option_vote_count`: Actualiza contadores de votos

#### Storage Bucket
- Bucket: `media` (p√∫blico)
- Pol√≠ticas: lectura p√∫blica, subida autenticada, eliminaci√≥n solo del owner

---

### 4. **CreatePostScreen Refactorizado** (`src/screens/CreatePostScreen.tsx`)

#### Estado Principal
```typescript
// Auth
currentUser: User | null

// Content
content: string
audience: AudienceOption

// Media
mediaItems: MediaItem[]

// Poll
pollData: PollData | null

// Celebration
celebrationType: CelebrationType | null

// Partnership
partnershipData: PartnershipData | null

// UI
loading: boolean
loadingData: boolean
showAudiencePicker: boolean
showPollEditor: boolean
isOnline: boolean
```

#### Caracter√≠sticas Implementadas

**‚úÖ Pixel-Perfect UI**
- Header: ArrowLeft + "Compartir publicaci√≥n" (16/semibold) + bot√≥n "Publicar" (#3B82F6)
- Avatar real del usuario (40-48px, redondeado)
- Chip audiencia: pill con badge + caret (usa AudiencePicker)
- Editor: font 18, placeholder #6B7280, contador 12 (#9CA3AF, rojo si > 2000)
- Sheet inferior: 5 opciones (foto, video, celebrar, documento, encuesta)
- Indicador inferior centrado (barra 134x4, #111)

**‚úÖ Backend-Driven**
- Cero hardcodes (no URLs est√°ticas de avatars)
- Avatar real desde `getCurrentUser()`
- Comunidades desde `listCommunitiesPaged()`
- Subida real a Supabase Storage
- Creaci√≥n con `createPostFull()`

**‚úÖ Autosave**
- Guarda borrador cada 2 segundos si hay cambios
- Restaura al reabrir con confirmaci√≥n

**‚úÖ Manejo de Errores**
- Mensajes claros por tipo de error (red, auth, permisos)
- Bot√≥n "Reintentar" en errores
- Logs descriptivos en consola

**‚úÖ Upload con Progreso**
- Barra de progreso por archivo
- Retry individual en caso de error
- Validaci√≥n de permisos

**‚úÖ Validaciones**
- Publish habilitado solo si hay contenido/media/poll/celebration/partnership
- M√°ximo 2000 caracteres (contador en rojo si excede)
- Poll: 2-5 opciones, 80 chars c/u
- Permisos de galer√≠a/documentos

**‚úÖ Accesibilidad**
- `accessibilityLabel` en todos los botones
- `accessibilityRole` apropiado
- `hitSlop` de 44px m√≠nimo
- Soporte para lectores de pantalla

**‚úÖ Performance**
- `useCallback` y `useMemo` para evitar re-renders
- `InteractionManager` al montar
- Animaciones suaves con modales

---

## üß™ Checklist de QA/UX

### Pixel-Perfect
- [ ] M√°rgenes exactos (20px horizontal, 16px vertical)
- [ ] Tipograf√≠as correctas (16/semibold header, 18 editor, 12 contador)
- [ ] Colores exactos (#3B82F6 bot√≥n, #6B7280 placeholder, #9CA3AF contador)
- [ ] Avatar 40-48px redondeado
- [ ] Chip audiencia con caret
- [ ] Sheet inferior con 5 opciones y separadores #E5E7EB
- [ ] Indicador inferior centrado 134x4 #111

### Funcionalidad
- [ ] Publish habilitado solo si hay contenido
- [ ] Contador de caracteres funcional (rojo si > 2000)
- [ ] Subida de media con barra de progreso
- [ ] Retry por archivo en caso de error
- [ ] Poll: 2-5 opciones, 80 chars, duraci√≥n 1/3/7 d√≠as
- [ ] Celebration: 5 tipos seleccionables
- [ ] Partnership: form con 3 campos
- [ ] AudiencePicker: b√∫squeda con debounce 300ms
- [ ] AudiencePicker: paginaci√≥n "pull to append"
- [ ] Autosave cada 2s
- [ ] Restauraci√≥n de borrador al reabrir
- [ ] Manejo de errores con mensajes claros

### Permisos
- [ ] Solicita permisos de galer√≠a para fotos
- [ ] Solicita permisos de galer√≠a para videos
- [ ] Solicita permisos de archivos para documentos
- [ ] Mensajes claros si se deniegan permisos

### Errores
- [ ] Toast/alert claro por cada tipo de error
- [ ] Bot√≥n "Reintentar" en errores de red
- [ ] Bot√≥n "Cancelar" para abortar
- [ ] Logs descriptivos en consola

### Accesibilidad
- [ ] Todos los botones tienen `accessibilityLabel`
- [ ] Todos los botones tienen `accessibilityRole`
- [ ] Targets m√≠nimos de 44px
- [ ] Soporte para lectores de pantalla

---

## üì° Endpoints/Funciones Nuevas

### 1. `uploadMedia`
**Request**:
```typescript
uploadMedia(
  'file:///path/to/image.jpg',
  'image',
  'user-uuid'
)
```
**Response**:
```json
{
  "url": "https://paoliakwfoczcallnecf.supabase.co/storage/v1/object/public/media/images/user-uuid/2025-10-01/1738435200_abc123.jpg",
  "mime": "image/jpeg",
  "bytes": 245678
}
```

### 2. `listCommunitiesPaged`
**Request**:
```typescript
listCommunitiesPaged('user-uuid', 'invers', 1, 20)
```
**Response**:
```json
{
  "items": [
    {
      "id": "community-uuid",
      "name": "Inversores Nicaragua",
      "image_url": "https://...",
      "member_count": 1250
    }
  ],
  "hasMore": true
}
```

### 3. `createPostFull`
**Request**:
```typescript
createPostFull({
  user_id: 'user-uuid',
  content: 'Mi primer post con encuesta!',
  audience_type: 'community',
  audience_id: 'community-uuid',
  media: [
    {
      url: 'https://.../image.jpg',
      type: 'image',
      mime: 'image/jpeg',
      size: 245678
    }
  ],
  poll: {
    options: ['Opci√≥n A', 'Opci√≥n B', 'Opci√≥n C'],
    duration_days: 3
  }
})
```
**Response**:
```json
{
  "id": "post-uuid"
}
```

### 4. Draft Management
**Save**:
```typescript
await saveDraft({
  content: 'Borrador...',
  audience: { id: 'profile', name: 'Mi Perfil', type: 'profile' },
  media: [...],
  poll: null,
  celebration: null,
  partnership: null
})
```

**Load**:
```typescript
const draft = await loadDraft()
// Returns: { content, audience, media, poll, celebration, partnership } | null
```

**Clear**:
```typescript
await clearDraft()
```

---

## üöÄ Pasos para Implementar en Supabase

### 1. Ejecutar SQL Migration
```bash
# En Supabase SQL Editor
# Copiar y pegar el contenido de supabase/sql/create_post.sql
# Ejecutar todo el archivo
```

### 2. Crear Storage Bucket
```bash
# En Supabase Dashboard > Storage
# 1. Crear bucket "media" (p√∫blico)
# 2. Agregar pol√≠ticas:
#    - SELECT: p√∫blico
#    - INSERT: autenticado
#    - DELETE: solo owner (verificar user_id en path)
```

### 3. Verificar Tablas Existentes
Aseg√∫rate de que existan:
- `posts` (id, user_id, contenido, community_id, created_at)
- `users` (id, nombre, avatar_url, photo_url, role, bio)
- `communities` (id, nombre, icono_url, descripcion)
- `user_communities` (user_id, community_id, joined_at)

### 3. **Instalar Dependencias**
```bash
npm install @react-native-async-storage/async-storage
```
2. **RPC Fallback**: `createPostFull` intenta usar el RPC `create_post_with_children` Primero, pero si no existe, hace fallback a inserts manuales.

4. **Alert.prompt**: En Android, `Alert.prompt` no est√° disponible. Para partnership, considera usar un modal custom.

5. **Iniciales de Avatar**: Si no hay `image_url`, se muestran iniciales del nombre (m√°ximo 2 letras).

6. **B√∫squeda de Comunidades**: Actualmente es client-side. Para mejor performance con muchas comunidades, implementa b√∫squeda server-side en el RPC.

7. **Documentos Eliminados**: Se removi√≥ soporte para documentos y la dependencia `expo-document-picker` para mantener el proyecto ligero.

8. **Detecci√≥n Offline Eliminada**: Se removi√≥ `@react-native-community/netinfo` para reducir dependencias. Los errores de red se manejan con try/catch.

---

## ‚úÖ Estado del Refactor

- ‚úÖ Componentes nuevos creados
- ‚úÖ API client actualizado
- ‚úÖ SQL migrations completas
- ‚úÖ CreatePostScreen refactorizado (PENDIENTE: reemplazar archivo completo)
- ‚úÖ Documentaci√≥n completa
- ‚úÖ Checklist de QA
- ‚úÖ Lista de endpoints

**Pr√≥ximo paso**: Reemplazar completamente el archivo `CreatePostScreen.tsx` con la versi√≥n refactorizada (el archivo actual tiene c√≥digo mezclado del viejo y nuevo).

---

## üé® Dise√±o UI Exacto

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚Üê  Compartir publicaci√≥n      Publicar  ‚îÇ ‚Üê Header (white bg, border bottom)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ  üë§  Paolo Fern√°ndez                    ‚îÇ ‚Üê Avatar + nombre (16/bold)
‚îÇ      üåê Comunidad ‚ñº                     ‚îÇ ‚Üê Chip audiencia (pill + caret)
‚îÇ                                         ‚îÇ
‚îÇ  ¬øQu√© est√°s pensando?                   ‚îÇ ‚Üê Editor (18/regular, #6B7280)
‚îÇ                                         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ                                    0/2000‚îÇ ‚Üê Contador (12, #9CA3AF)
‚îÇ                                         ‚îÇ
‚îÇ         ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                        ‚îÇ ‚Üê Divider horizontal
‚îÇ                                         ‚îÇ
‚îÇ  üì∑  Agregar una foto                   ‚îÇ ‚Üê Opciones (icono 22 + label 15/500)
‚îÇ  üé•  Agregar un video                   ‚îÇ
‚îÇ  ‚≠ê  Celebrar un momento                ‚îÇ
‚îÇ  üìÑ  Agregar un documento               ‚îÇ
‚îÇ  üìä  Crea una encuesta                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                       ‚Üê Indicador inferior (134x4, #111)
```

---

**Fin de la documentaci√≥n** üéâ
